<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Moodle Downloader - Hebrew Support Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 10px;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #2196F3;
            background-color: #f9f9f9;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .pass {
            background-color: #c8e6c9;
            color: #2e7d32;
        }
        .fail {
            background-color: #ffcdd2;
            color: #c62828;
        }
        .code {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: right;
        }
        th {
            background-color: #2196F3;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª ×‘×“×™×§×ª ×ª××™×›×” ×‘×¢×‘×¨×™×ª - Hebrew Support Test</h1>
        
        <div class="test-case">
            <h2>Test 1: Supported Files Detection</h2>
            <p>Verifying that both English and Hebrew file types are in SUPPORTED_FILES set</p>
            <div class="code" id="test1-code"></div>
            <div class="test-result" id="test1-result"></div>
        </div>

        <div class="test-case">
            <h2>Test 2: File Type Mapping</h2>
            <p>Checking English to Hebrew file type mappings:</p>
            <table>
                <thead>
                    <tr>
                        <th>English Type</th>
                        <th>Hebrew Type</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="test2-table"></tbody>
            </table>
        </div>

        <div class="test-case">
            <h2>Test 3: Mock Moodle Element Test</h2>
            <p>Simulating Moodle HTML structure with Hebrew elements</p>
            <div id="test3-moodle" style="display: none;"></div>
            <div class="test-result" id="test3-result"></div>
        </div>

        <div class="test-case">
            <h2>Test 4: Filename Sanitization</h2>
            <p>Testing that Hebrew filenames are properly sanitized</p>
            <table>
                <thead>
                    <tr>
                        <th>Original Hebrew Filename</th>
                        <th>Sanitized Result</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="test4-table"></tbody>
            </table>
        </div>

        <div class="test-case">
            <h2>Summary</h2>
            <div id="summary"></div>
        </div>
    </div>

    <script>
        // Supported file types (from background.js)
        const SUPPORTED_FILES = new Set([
            "File",           // English: File
            "Folder",         // English: Folder
            "URL",            // English: URL
            "Page",           // English: Page
            "×§×•×‘×¥",           // Hebrew: File
            "×ª×™×§×™×™×”",         // Hebrew: Folder
            "×›×ª×•×‘×ª ××™× ×˜×¨× ×˜",  // Hebrew: URL
            "×“×£"              // Hebrew: Page
        ]);

        const fileTypeMappings = [
            { english: "File", hebrew: "×§×•×‘×¥" },
            { english: "Folder", hebrew: "×ª×™×§×™×™×”" },
            { english: "URL", hebrew: "×›×ª×•×‘×ª ××™× ×˜×¨× ×˜" },
            { english: "Page", hebrew: "×“×£" }
        ];

        const hebrewFilenames = [
            "×©×™×¢×•×¨_××ª××˜×™×§×”.pdf",
            "×ª×¨×’×™×œ_×—×–×¨×”.docx",
            "××¦×’×ª_×”×¡×ª×‘×¨×•×ª.pptx",
            "×§×¨×™××”_× ×“×¨×©×ª_×¤×¨×§_3.pdf"
        ];

        let testsPassed = 0;
        let testsFailed = 0;

        function sanitiseFilename(filename) {
            return filename.replace(/[\\/:*?"<>|]/g, "-");
        }

        // Test 1: Supported Files Detection
        function test1() {
            const englishTypes = ["File", "Folder", "URL", "Page"];
            const hebrewTypes = ["×§×•×‘×¥", "×ª×™×§×™×™×”", "×›×ª×•×‘×ª ××™× ×˜×¨× ×˜", "×“×£"];
            const allTypes = [...englishTypes, ...hebrewTypes];
            
            let allPresent = true;
            let code = "";
            
            code += "Checking SUPPORTED_FILES set:\n\n";
            allTypes.forEach(type => {
                const present = SUPPORTED_FILES.has(type);
                code += `"${type}": ${present ? 'âœ“' : 'âœ—'}\n`;
                if (!present) allPresent = false;
            });

            document.getElementById("test1-code").textContent = code;
            
            if (allPresent) {
                document.getElementById("test1-result").className = "test-result pass";
                document.getElementById("test1-result").textContent = "âœ“ PASS: All file types are supported";
                testsPassed++;
            } else {
                document.getElementById("test1-result").className = "test-result fail";
                document.getElementById("test1-result").textContent = "âœ— FAIL: Some file types are missing";
                testsFailed++;
            }
        }

        // Test 2: File Type Mapping
        function test2() {
            const tbody = document.getElementById("test2-table");
            let allMapped = true;
            
            fileTypeMappings.forEach(mapping => {
                const row = tbody.insertRow();
                const englishCell = row.insertCell(0);
                const hebrewCell = row.insertCell(1);
                const statusCell = row.insertCell(2);
                
                const englishExists = SUPPORTED_FILES.has(mapping.english);
                const hebrewExists = SUPPORTED_FILES.has(mapping.hebrew);
                const bothExist = englishExists && hebrewExists;
                
                englishCell.textContent = mapping.english;
                hebrewCell.textContent = mapping.hebrew;
                
                if (bothExist) {
                    statusCell.textContent = "âœ“ PASS";
                    statusCell.style.color = "#2e7d32";
                } else {
                    statusCell.textContent = "âœ— FAIL";
                    statusCell.style.color = "#c62828";
                    allMapped = false;
                }
            });

            if (allMapped) testsPassed++;
            else testsFailed++;
        }

        // Test 3: Mock Moodle Element Test
        function test3() {
            const mockMoodle = document.getElementById("test3-moodle");
            
            // Create a mock Moodle activity with Hebrew type
            mockMoodle.innerHTML = `
                <div class="activity">
                    <span class="instancename">
                        <span>××¦×’×ª_×”×¡×ª×‘×¨×•×ª.pdf</span>
                        <span>×§×•×‘×¥</span>
                    </span>
                    <a href="http://example.com/course/moodledata/file.pdf">Link</a>
                </div>
            `;

            const activity = mockMoodle.querySelector(".activity");
            const instanceName = activity.querySelector(".instancename");
            const fileType = instanceName.lastChild.textContent.trim();
            
            const isSupported = SUPPORTED_FILES.has(fileType);
            
            if (isSupported) {
                document.getElementById("test3-result").className = "test-result pass";
                document.getElementById("test3-result").textContent = `âœ“ PASS: Hebrew file type "${fileType}" is recognized as supported`;
                testsPassed++;
            } else {
                document.getElementById("test3-result").className = "test-result fail";
                document.getElementById("test3-result").textContent = `âœ— FAIL: Hebrew file type "${fileType}" is not recognized`;
                testsFailed++;
            }
        }

        // Test 4: Filename Sanitization
        function test4() {
            const tbody = document.getElementById("test4-table");
            let allSanitized = true;
            
            hebrewFilenames.forEach(filename => {
                const row = tbody.insertRow();
                const originalCell = row.insertCell(0);
                const sanitizedCell = row.insertCell(1);
                const statusCell = row.insertCell(2);
                
                const sanitized = sanitiseFilename(filename);
                
                originalCell.textContent = filename;
                sanitizedCell.textContent = sanitized;
                
                // Check if sanitization preserved Hebrew characters but removed forbidden chars
                const hasForbiddenChars = /[\\/:*?"<>|]/.test(sanitized);
                const preservesHebrew = /[\u0590-\u05FF]/.test(sanitized);
                
                if (!hasForbiddenChars && preservesHebrew) {
                    statusCell.textContent = "âœ“ PASS";
                    statusCell.style.color = "#2e7d32";
                } else if (hasForbiddenChars) {
                    statusCell.textContent = "âœ— FAIL: Contains forbidden chars";
                    statusCell.style.color = "#c62828";
                    allSanitized = false;
                } else if (!preservesHebrew) {
                    statusCell.textContent = "âš  WARNING: Hebrew chars removed";
                    statusCell.style.color = "#f57f17";
                }
            });

            if (allSanitized) testsPassed++;
            else testsFailed++;
        }

        // Run all tests
        function runAllTests() {
            test1();
            test2();
            test3();
            test4();

            // Summary
            const summary = document.getElementById("summary");
            const total = testsPassed + testsFailed;
            const percentage = Math.round((testsPassed / total) * 100);
            
            let summaryText = `
                <strong>Tests Passed:</strong> ${testsPassed}/${total} (${percentage}%)<br>
                <strong>Tests Failed:</strong> ${testsFailed}/${total}
            `;
            
            if (testsFailed === 0) {
                summary.innerHTML = `<div class="test-result pass">${summaryText}</div>`;
                summary.innerHTML += "<p><strong>âœ“ All tests passed! Hebrew support is working correctly.</strong></p>";
            } else {
                summary.innerHTML = `<div class="test-result fail">${summaryText}</div>`;
                summary.innerHTML += "<p><strong>âœ— Some tests failed. Please review the errors above.</strong></p>";
            }
        }

        // Run tests when page loads
        window.addEventListener('load', runAllTests);
    </script>
</body>
</html>
